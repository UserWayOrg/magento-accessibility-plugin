<script>
    require([
        'jquery'
    ], function ($) {

        const MESSAGE_ACTION_TOGGLE = 'WIDGET_TOGGLE';

        const request = (url, data) => {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url,
                    data,
                    type: 'POST',
                    dataType: 'json'
                }).done(data => resolve(data))
                .fail(err => reject(err));
            })
        }

        const requestUpdate = (url, recordId, accountId) =>
            request(url, {
                accountId,
                recordId
            })

        const requestToggleState = (url, recordId, state) =>
            request(url, {
                state,
                recordId
            })

        const isPostMessageAccountAction = (postMessage) => postMessage.data
            && postMessage.data.account
            && postMessage.data.account.length > 0;

        const isPostMessageAccountToggleAction = (postMessage) => {
            return postMessage.data
                && postMessage.data.action
                && postMessage.data.action === MESSAGE_ACTION_TOGGLE
        }

        $(document).ready(function () {
            const selector = document.getElementById('userway-frame');
            const frameContentWindow = selector.contentWindow;
            const {url, toggleurl: toggleUrl, id} = selector.dataset;

            window.addEventListener('message', postMessage => {
                if (postMessage.source !== frameContentWindow) {
                    return;
                }

                if (isPostMessageAccountAction(postMessage)) {
                    requestUpdate(url, id, postMessage.data.account)
                        .then(res => console.log(res))
                        .catch(err => console.error(err));
                } else if (isPostMessageAccountToggleAction(postMessage)) {
                    const state = postMessage.data.state ? 1 : 0;
                    requestToggleState(toggleUrl, id, state)
                        .then(res => console.log(res))
                        .catch(err => console.error(err));
                }
            });
        });
    })
</script>
